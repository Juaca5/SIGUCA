extends layout

block sigucaCSS
  link(rel='stylesheet', href='/stylesheets/cal-heatmap.css')


block content
    div.container
      if(!feriado)
        div.text-center
          .milky Reportes de #{tipoReporte}

        div.filter
          table
            form(role='form', method="POST", action="/reportes/"+filtradoReporte)
              td
                select.form-control.selectpicker(data-style="btn-success", data-width="auto", type="text", name="filtro") 
                  option(value= "todos|reportes") Todos los usuarios
                  each user in usuarios
                    //-Se verifica si la informacion esta siendo filtrada por usuario
                    if(filtroUsuario && filtroUsuario == user._id)
                      option(value= user._id + "|reportes", selected) #{user.apellido1} #{user.apellido2}, #{user.nombre}
                    else
                      option(value= user._id + "|reportes") #{user.apellido1} #{user.apellido2}, #{user.nombre}

              td
                select.form-control#selectFiltro.selectpicker(data-style="btn-success", data-width="auto", type="text", name="filtro_departamento") 
                  option(value= "todos") Todos los departamentos
                  each dep in departamentos
                    //-Se verifica si la informacion esta siendo filtrada por departamento
                    if(filtroDepartamento && filtroDepartamento == dep._id)
                      option(value=dep._id, selected) #{dep.nombre}
                    else
                      option(value=dep._id ) #{dep.nombre}
              -if(vacaciones)
                td.hide
              -else
                td
                  label.labelFiltro.labFilLeft(for='fechaDesde') Desde:
                    div.input-group
                      input#date_range_start.form-control.fondoTransparente(type='text', name='fechaDesde', value=rangoFecha.fechaDesde)
                      span.input-group-addon.fondoTransparente-derecha
                        i.icon-calendar
              -if(vacaciones)
                td.hide
              -else
                td
                  label.labelFiltro(for='fechaHasta') Hasta:
                    div.input-group
                      input#date_range_end.form-control.fondoTransparente(type='text', name='fechaHasta', value=rangoFecha.fechaHasta)
                      span.input-group-addon.fondoTransparente-derecha
                        i.icon-calendar
              td
      
                button.filtro.form-control.btn.btn-success.fondoTransparente(type='submit', name='gestionar') Buscar
      else
        div.text-center
          .milky Reportes de #{tipoReporte}

      .col-xs-12
        div.eventosCierre
          h3 Detalle de la búsqueda
          table.footable.zoom-element
            thead
              tr
                th(data-sort-ignore="true") Acciones
                th(data-sort-ignore="true") Cantidad
            tbody#calDetalle
                //-Marcas
                if(marcas)
                  tr
                    td Marcas registradas
                    if(marcas.length != 0)
                      td #{marcas.length}
                    else
                      td 0
                
                //-Justificiones
                if(justificaciones)
                  tr
                    td Justificaciones
                    if(justificaciones.length != 0)
                      td #{justificaciones.length}
                    else
                      td 0

                //-Solicitudes de permisos
                if(permisos)
                  tr
                    td Solicitudes de permisos
                    if(permisos.length != 0)
                      td #{permisos.length}
                    else
                      td 0

                //-Solicitudes de horas extraordinarias
                if(extras)
                  tr
                    td Solicitudes de horas extraordinarias
                    if(extras.length != 0)
                      td #{extras.length}
                    else
                      td 0
                
                 if(feriado)
                  tr
                    td Feriados
                    if(feriado.length != 0)
                      td #{feriado.length}
                    else
                      td 0
                
                //-Vacaciones
                if(vacaciones)
                  tr
                    td Total empleados
                    td #{usuarios.length}

                //-Horas laboradas
                if(horasEmpleado)
                  tr
                    td total de horas laboradas
                    if(horasEmpleado.length != 0)
                      //-Se calcula el total de horas laboradas por empleado
                      -var sumaHoras = 0, sumaMinutos = 0;
                      each empleadoTem, p in horasEmpleado
                        - sumaHoras += empleadoTem.tiempo.horas;
                        if(sumaMinutos + empleadoTem.tiempo.minutos >= 60)
                          - sumaHoras ++
                          - sumaMinutos = (sumaMinutos + empleadoTem.tiempo.minutos) - 60
                        else
                          -sumaMinutos += empleadoTem.tiempo.minutos        

                      //- Se le da formato al tiempo sumado
                      - var tiempo ="";
                      - if(sumaHoras < 10 ) sumaHoras = "0" + sumaHoras;
                      - if(sumaMinutos < 10 ) sumaMinutos = "0" + sumaMinutos;
                      - tiempo = sumaHoras+":"+sumaMinutos;
                      td #{tiempo}
                    else
                      td 0
                  
        br
        div.tablasReportes
          if(resumen && resumen.length != 0)
            h3.h3Marcas Resumen
            table.footable
                thead
                    tr
                      th Tipo
                      th Cantidad
                tbody
                  each line in resumen
                    tr
                      td #{line.tipo}
                      td #{line.cantidad}
                tfoot
                  tr
                    td(colspan='2')

          
          if(horasEmpleado)
            if(horasEmpleado.length != 0)
              br
              h3 Horas laboradas por colaborador
              .tableSolicitudes.footable
                table#totalHorasEmpleado
                    thead
                      tr
                        th Tipo de usuario
                        th Usuario
                        th Tiempo trabajado
                            
                    tbody
                      each empleado, p in horasEmpleado
                        - var x = JSON.stringify(empleado);
                        - var tiempo ="";
                        - var h =""+empleado.tiempo.horas;
                        - var m =""+empleado.tiempo.minutos;
                        - if(empleado.tiempo.horas<10) h = "0"+h;
                        - if(empleado.tiempo.minutos<10) m = "0"+m;
                        - tiempo = h+":"+m;
                        - if(empleado.tiempo.horas<=0 && empleado.tiempo.minutos<=0) tiempo = "El usuario se ausentó o no marcó salida."
                        tr
                          td #{empleado.tipoUsuario}
                          td #{empleado.usuario.nombre} #{empleado.usuario.apellido1} 
                          td #{tiempo}
                         
            else
              h3 Horas laboradas por empleado
              p No se han encontrado registros

          
          //-Horas por dia
          if(cierreUsuarios)
            if(cierreUsuarios.length != 0)
              br
              h3 Horas trabajas por día 
              .tableCierres.footable
                table#horaTablaPDF
                    thead
                      tr
                        th Fecha
                        th Tipo de usuario
                        th Usuario
                        th Tiempo trabajado
                            
                    tbody
                      each cierre, i in cierreUsuarios
                        - var x = JSON.stringify(cierre);
                        - var tiempo ="";
                        - var h =""+cierre.tiempo.horas;
                        - var m =""+cierre.tiempo.minutos;
                        - if(cierre.tiempo.horas<10) h = "0"+h;
                        - if(cierre.tiempo.minutos<10) m = "0"+m;
                        - tiempo = h+":"+m;
                        - if(cierre.tiempo.horas<=0 && cierre.tiempo.minutos<=0) 
                          -tiempo = "El usuario se ausentó o no marcó salida."
                        tr
                          td(data-value=cierre.epoch) #{cierre.fecha.str} 
                          td #{cierre.tipoUsuario}
                          td #{cierre.usuario.nombre} #{cierre.usuario.apellido1} 
                          td #{tiempo}
            else
              h3 Horas Semanales 
              p No se han encontrado registros

          //-Marcas
          if(marcas)
            if(marcas.length != 0)
              h3 Marcas
              .footable
                table#marcasPDF
                    thead
                      tr
                        th(data-type="numeric" data-sort-initial="descending") Fecha
                        th Usuario
                        th Tipo
                        th Tipo de usuario
                    tbody
                      each marca, i in marcas
                        tr
                          td(data-value=marca.epoch) #{marca.fecha.str} 
                          td #{marca.usuario.nombre} #{marca.usuario.apellido1}
                          td #{marca.tipoMarca} 
                          td #{marca.tipoUsuario}
            else
              h3 Marcas 
              p No se han encontrado registros 
                           
           //-Tardias  
        
          if(arregloTardias)
            if(arregloTardias.length != 0)
              h3 Reporte tardias
              .footable
                table#tardiasPDF
                    thead
                      tr
                        th Tipo de usuario
                        th Usuario
                        th Hora de entrada
                        th Fecha y hora de marca
                        
                      
                    tbody
                      -for (var g = 0; g <arregloTardias.length; g++)
                        tr
                          th #{arregloTardias[g].tipoUsuario}
                          td #{arregloTardias[g].nombre} #{arregloTardias[g].apellido}
                         
                          if(arregloTardias[g].horarioMinutos < 10)
                            td #{arregloTardias[g].horarioHora+":"+arregloTardias[g].horarioMinutos+""+0}
                          else
                            td #{arregloTardias[g].horarioHora+":"+arregloTardias[g].horarioMinutos}
                          td #{arregloTardias[g].fecha}
            else
              h3 Reporte tardias 
              p No se han encontrado registros   
             
          if(marcasPorDia)
            if(marcasPorDia.length != 0)
                h3 Marcas diarias
                .footable
                  table#marcassPDF
                      thead
                        tr
                          th Tipo usuario
                          th Usuario
                          th Entrada
                          th Salida Almuerzo
                          th Entrada Almuerzo
                          th Salida a Receso
                          th Entrada a Receso
                          th Salida
                      tbody
                        -for(var s=0;s<marcasPorDia.length;s++)  
                          tr
                            td  #{marcasPorDia[s].tipoUsuario}
                            td  #{marcasPorDia[s].nombre} #{marcasPorDia[s].apellido1}
                            td  #{marcasPorDia[s].entrada}
                            td  #{marcasPorDia[s].salidaAlmuerzo}
                            td  #{marcasPorDia[s].entradaAlmuerzo}
                            td  #{marcasPorDia[s].salidaReceso}
                            td  #{marcasPorDia[s].entradaReceso}
                            td  #{marcasPorDia[s].salida}
              else
                h3 Marcas diarias
                p No se han encontrado registros               

          //-Justificaciones     
          if(justificaciones)
            if(justificaciones.length != 0)
              h3 Justificaciones
              .tableJustificaciones  
                table#justificacionesPDF
                    thead
                      tr
                        th(data-type="numeric" data-sort-initial="descending") Fecha
                        th Usuario
                        th Tipo Usuario
                        th(data-hide="phone,small") Motivo
                        th(data-hide="phone,small" data-sort-ignore="true") Detalle
                        th(data-hide="phone,small" data-sort-ignore="true") Comentario
                        th Estado
                        th(data-hide="phone,small" data-sort-ignore="true") Eliminar
                    tbody
                      each justificacion, i in justificaciones
                        tr
                          td(data-value=justificacion.fechaCreada) #{justificacion.fecha.str} 
                          if(justificacion.usuario)
                            td #{justificacion.usuario.nombre} #{justificacion.usuario.apellido1}
                          td #{justificacion.tipoUsuario} 
                          td #{justificacion.motivo}    
                          td #{justificacion.detalle} 
                          td #{justificacion.comentarioSupervisor} 
                          td #{justificacion.estado}  
                          td
                            if(justificacion.usuario)
                              button.btn.btn-default.justificacionDelete(value=justificacion.usuario.nombre+' '+justificacion.usuario.apellido1+' '+justificacion.usuario.apellido2+','+justificacion.id+','+justificacion.fecha.str, name='eliminar') 
                                i.icon-trash.icon-large.i-danger 
            else
              h3 Justificaciones
              p No se han encontrado registros        
                       
          //-Solicitudes Horas Extraordinarias
          if(extras)
            if(extras.length != 0)
              br
              h3 Solicitudes Horas Extraordinarias
              .tableSolicitudes.footable
                table#extraPDF
                    thead
                      tr
                        th(data-type="numeric" data-sort-initial="descending") Fecha
                        th Usuario
                        th(data-hide="phone,small" data-sort-ignore="true") Día de Inicio 
                        th(data-hide="phone,small" data-sort-ignore="true") Día de Termino
                        th(data-hide="phone,small,medium" data-sort-ignore="true") Cantidad de Horas
                        th(data-hide="phone,small,medium") Cliente
                        th(data-hide="phone,small,medium" data-sort-ignore="true") Motivo
                        th(data-hide="phone,small,medium" data-sort-ignore="true") Comentario
                        th(data-hide="phone,small") Estado
                        th(data-hide="phone,small,medium" data-sort-ignore="true") Eliminar
                    tbody
                      each extra, i in extras
                        tr
                          td(data-value=extra.fechaCreada) #{extra.fecha.str} 
                          if(extra.usuario)
                          td #{extra.usuario.nombre} #{extra.usuario.apellido1} 
                          td #{extra.diaInicio} 
                          td #{extra.diaFinal} 
                          td #{extra.cantHoras} 
                          td #{extra.cliente} 
                          td #{extra.motivo} 
                          td #{extra.comentarioSupervisor} 
                          td #{extra.estado} 
                          td
                            if(extra.usuario)
                              button.btn.btn-default.solicitudDelete(value=extra.usuario.nombre+' '+extra.usuario.apellido1+' '+extra.usuario.apellido2+','+extra.id+','+extra.fecha.str, name='eliminar') 
                              i.icon-trash.icon-large.i-danger 
            else
              h3 Solicitudes Horas Extraordinarias
              p No se han encontrado registros 
          
          //-Solicitudes Permisos
          if(permisos)
            if(permisos.length != 0)
              br
              h3 Solicitudes Permisos
              .tableSolicitudes.footable
                table#permisoPDF
                    thead
                      tr
                        th(data-type="numeric" data-sort-initial="descending") Fecha
                        th Usuario
                        th(data-hide="phone,small") Día Inicial
                        th(data-hide="phone,small") Día Final 
                        th(data-hide="phone,small") Cantidad Días
                        th(data-hide="phone,small,medium") Motivo
                        th(data-hide="phone,small,medium" data-sort-ignore="true") Detalle
                        th(data-hide="phone,small,medium" data-sort-ignore="true") Comentario
                        th Estado
                        th(data-hide="phone,small,medium" data-sort-ignore="true") Eliminar
                    tbody
                      each permiso, i in permisos
                        tr
                          td(data-value=permiso.fechaCreada) #{permiso.fecha.str} 
                          if(permiso.usuario)
                            td #{permiso.usuario.nombre} #{permiso.usuario.apellido1} 
                          td #{permiso.diaInicio} 
                          td #{permiso.diaFinal} 
                          td #{permiso.cantidadDias} 
                          td #{permiso.motivo} 
                          td #{permiso.detalle} 
                          td #{permiso.comentarioSupervisor} 
                          td #{permiso.estado} 
                          td
                            if(permiso.usuario)
                              button.btn.btn-default.solicitudDelete(value=permiso.usuario.nombre+' '+permiso.usuario.apellido1+' '+permiso.usuario.apellido2+','+permiso.id+','+permiso.fecha.str, name='eliminar') 
                                i.icon-trash.icon-large.i-danger 
            else
              h3 Solicitudes Permisos
              p No se han encontrado registros 

          //-lista de feriados
          if(feriado)
            if(feriado.lenght!=0)
              br
              h3 Lista de feriados
              table.footable.tableFeriado
                  thead
                    tr
                      th Nombre
                      th Fecha
                      
  
                  tbody 
                    each feriadoCurrent, i in feriado
                      tr
                        td #{feriadoCurrent.nombreFeriado} 
                        td #{feriadoCurrent.epoch} 
            else
              h3 Feriados
              p No se han encontrado registros

          //-Solicitudes Vacaciones
          if(vacaciones)
              br
              h3 Vacaciones
              .tableSolicitudes.footable
                table#permisoPDF
                    thead
                      tr

                        th Nombre
                        th Apellidos
                        th(data-hide="phone") Cédula
                        th(data-hide="phone,small,medium,large") Email
                        th(data-hide="phone,small") Estado
                        th(data-hide="phone,small") Días disponibles
                    tbody
                      form(method="POST", action="/vacacionesUpdate")
                        each elemento, i in usuarios
                            tr
                              td #{elemento.nombre}
                              td #{elemento.apellido1} #{elemento.apellido2} 
                              td #{elemento.cedula} 
                              td #{elemento.email} 
                              td #{elemento.estado}
                              td.text-center #{elemento.vacaciones}

block sigucaJS  
  script(src="/js/app/reportes.js")
  script(src="/socket.io/socket.io.js")
  script(src="/js/components/d3.min.js")
  script(src="/js/components/cal-heatmap.js")
  script( src='/js/app/sigucaHome.js')
